<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calcolatore Ricette</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #fdfdfd;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    .section {
      margin-bottom: 30px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 10px;
    }
    .flex-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .flex-row input, .flex-row select {
      flex: 1;
      padding: 8px;
    }
    button {
      padding: 10px 15px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background-color: #2980b9;
    }
    #output {
      margin-top: 20px;
      padding: 15px;
      background: #eaf7ea;
      border: 1px solid #b4d6b4;
      border-radius: 10px;
    }
    .space-below {
      margin-bottom: 15px;
    }
    @media print {
      button, input, select, .section-url {
        display: none;
      }
    }
  </style>
</head>
<body>
  <h1>üç¥ Calcolo Ricette - CRC</h1>

  <div class="section section-url">
    <h3>1. Inserisci un link a una ricetta</h3>
    <div class="flex-row space-below">
      <input type="text" id="recipe-url" placeholder="https://..." />
      <button onclick="fetchRecipe()">Carica Ricetta</button>
    </div>
  </div>

  <div class="section">
    <h3>2. Inserisci Ingredienti Manualmente</h3>
    <div id="ingredient-container"></div>
    <button onclick="addIngredient()">+ Aggiungi Ingrediente</button>
  </div>

  <div class="section">
    <h3>3. Imposta Porzioni</h3>
    <div class="flex-row">
      <input type="number" id="original-people" placeholder="Porzioni originali" />
      <input type="number" id="desired-people" placeholder="Porzioni desiderate" />
    </div>
  </div>

  <div class="section">
    <button onclick="calculateQuantities()">CALCOLA</button>
    <span style="margin-left: 15px;"></span>
    <button onclick="window.print()">STAMPA</button>
  </div>

  <div id="output"></div>

  <script>
    const ingredientContainer = document.getElementById("ingredient-container");

    function addIngredient() {
      const row = document.createElement("div");
      row.className = "flex-row";
      row.innerHTML = `
        <div><input type="text" class="ingredient-name" placeholder="Ingrediente" /></div>
        <div><input type="number" class="ingredient-quantity" placeholder="Quantit√†" /></div>
        <div>
          <select class="ingredient-unit">
            <option value="">-</option>
            <option value="g">g</option>
            <option value="ml">ml</option>
            <option value="cucchiai">cucchiai</option>
            <option value="cucchiaini">cucchiaini</option>
            <option value="pezzi">pezzi</option>
            <option value="tazze">tazze</option>
          </select>
        </div>
      `;
      ingredientContainer.appendChild(row);
    }

    function calculateQuantities() {
      const originalPeople = parseFloat(document.getElementById("original-people").value);
      const desiredPeople = parseFloat(document.getElementById("desired-people").value);
      const output = document.getElementById("output");
      output.innerHTML = "";

      if (!originalPeople || !desiredPeople || desiredPeople <= 0) {
        alert("Inserisci il numero di persone corretto.");
        return;
      }

      const names = document.querySelectorAll(".ingredient-name");
      const quantities = document.querySelectorAll(".ingredient-quantity");
      const units = document.querySelectorAll(".ingredient-unit");

      output.innerHTML = "<h3>Ingredienti Ricalcolati:</h3><ul>";

      for (let i = 0; i < names.length; i++) {
        const name = names[i].value;
        const quantity = parseFloat(quantities[i].value);
        const unit = units[i].value;

        if (!name || isNaN(quantity)) continue;

        const newQuantity = quantity * (desiredPeople / originalPeople);
        const rounded = (unit === "pezzi") ? newQuantity.toFixed(1) : Math.round(newQuantity);
        output.innerHTML += `<li>${name}: <strong>${rounded} ${unit}</strong> <em>(originale: ${quantity} ${unit})</em></li>`;
      }

      output.innerHTML += "</ul>";
    }

    async function fetchRecipe() {
      const url = document.getElementById("recipe-url").value;
      if (!url) {
        alert("Inserisci un URL valido.");
        return;
      }

      try {
        const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
        const data = await response.json();
        const html = data.contents;
        const doc = new DOMParser().parseFromString(html, "text/html");
        const scripts = doc.querySelectorAll('script[type="application/ld+json"]');

        let recipeData = null;
        scripts.forEach(script => {
          try {
            const json = JSON.parse(script.textContent);
            if (json["@type"] === "Recipe") recipeData = json;
          } catch {}
        });

        if (!recipeData || !recipeData.recipeIngredient) {
          alert("Dati della ricetta non trovati o non compatibili.");
          return;
        }

        ingredientContainer.innerHTML = "";

        const unitOptions = ["g", "grammi", "ml", "l", "cucchiai", "cucchiaini", "pezzi", "tazze", "kg", "cl"];
        recipeData.recipeIngredient.forEach(rawText => {
          const match = rawText.trim().match(/^([\d.,\/]+)?\s*(\w+)?\s*(.*)$/);
          let quantity = parseFloat(match[1]?.replace(",", ".") || 0);
          let unit = match[2]?.toLowerCase() || "";
          let name = match[3] || rawText;

          if (!unitOptions.includes(unit)) {
            name = `${unit} ${name}`.trim();
            unit = "";
          }

          const row = document.createElement("div");
          row.className = "flex-row";
          row.innerHTML = `
            <div><input type="text" value="${name}" class="ingredient-name" /></div>
            <div><input type="number" value="${isNaN(quantity) ? '' : quantity}" class="ingredient-quantity" /></div>
            <div>
              <select class="ingredient-unit">
                <option value="">-</option>
                <option value="g" ${unit === "g" ? "selected" : ""}>g</option>
                <option value="ml" ${unit === "ml" ? "selected" : ""}>ml</option>
                <option value="cucchiai" ${unit === "cucchiai" ? "selected" : ""}>cucchiai</option>
                <option value="cucchiaini" ${unit === "cucchiaini" ? "selected" : ""}>cucchiaini</option>
                <option value="pezzi" ${unit === "pezzi" ? "selected" : ""}>pezzi</option>
                <option value="tazze" ${unit === "tazze" ? "selected" : ""}>tazze</option>
              </select>
            </div>`;
          ingredientContainer.appendChild(row);
        });

        document.getElementById("original-people").value = parseInt(recipeData.recipeYield) || 4;

      } catch (err) {
        console.error(err);
        alert("Errore nel caricamento della ricetta.");
      }
    }
  </script>
</body>
</html>
