<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ricalcolatore Ricette</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      padding: 20px;
    }
    h2 {
      margin-top: 20px;
    }
    .ingredient-row {
      margin-bottom: 10px;
    }
    .btn-print {
      margin-top: 10px;
    }
  </style>
</head>
<body>
<div class="container">
  <h2>Inserisci un link a una ricetta</h2>
  <div class="mb-3">
    <input type="text" id="recipeUrl" class="form-control" placeholder="Inserisci il link della ricetta">
  </div>
  <button class="btn btn-primary mb-4" onclick="extractIngredients()">Estrai ingredienti dal link</button>

  <h4>Oppure inserisci manualmente la ricetta</h4>
  <div id="ingredienti"></div>
  <button class="btn btn-outline-primary my-3" onclick="aggiungiIngrediente()">
    ‚ûï Aggiungi Ingrediente
  </button>

  <div class="row mb-3">
    <div class="col">
      <input type="number" id="porzioniOriginali" class="form-control" placeholder="Porzioni originali">
    </div>
    <div class="col">
      <input type="number" id="porzioniDesiderate" class="form-control" placeholder="Porzioni desiderate">
    </div>
    <div class="col">
      <button class="btn btn-success w-100" onclick="ricalcola()">
        üìä Calcola
      </button>
    </div>
  </div>

  <div id="output"></div>
  <button class="btn btn-secondary btn-print" onclick="window.print()">üñ®Ô∏è Stampa</button>
</div>

<script>
const unitaMisura = ['g', 'kg', 'ml', 'l', 'pezzi', 'q.b.', 'cucchiai', 'cucchiaini', 'tazze', 'fette', 'bicchieri', 'pizzichi', 'n.'];

function aggiungiIngrediente(nome='', quantita='', unita='') {
  const container = document.getElementById('ingredienti');
  const row = document.createElement('div');
  row.className = 'row ingredient-row';
  row.innerHTML = `
    <div class="col">
      <input type="text" class="form-control" value="${nome}" placeholder="Ingrediente">
    </div>
    <div class="col">
      <input type="number" class="form-control" value="${quantita}" placeholder="Quantit√†">
    </div>
    <div class="col">
      <select class="form-control">
        ${unitaMisura.map(u => `<option value="${u}" ${u === unita ? 'selected' : ''}>${u}</option>`).join('')}
      </select>
    </div>`;
  container.appendChild(row);
}

function ricalcola() {
  const originali = parseInt(document.getElementById('porzioniOriginali').value);
  const desiderate = parseInt(document.getElementById('porzioniDesiderate').value);
  const scale = desiderate / originali;
  const righe = document.querySelectorAll('.ingredient-row');
  let html = `<h3>Ingredienti Ricalcolati</h3><table class="table"><thead><tr><th>Ingrediente</th><th>Originale</th><th>Ricalcolato</th></tr></thead><tbody>`;

  righe.forEach(r => {
    const nome = r.children[0].children[0].value;
    const quantita = parseFloat(r.children[1].children[0].value);
    const unita = r.children[2].children[0].value;
    const ricalcolato = unita === 'pezzi' || unita === 'q.b.' ? quantita : Math.round(quantita * scale);
    html += `<tr><td>${nome}</td><td>${quantita} ${unita}</td><td>${ricalcolato} ${unita}</td></tr>`;
  });

  html += '</tbody></table>';
  document.getElementById('output').innerHTML = html;
}

function extractIngredients() {
  const url = document.getElementById('recipeUrl').value;
  fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`)
    .then(response => response.json())
    .then(data => {
      const html = document.createElement('html');
      html.innerHTML = data.contents;

      // Trova le porzioni
      const testo = html.textContent;
      const porzioniMatch = testo.match(/(per|dosi per|dosi da|dose da)\s+(\d+)\s+(persone|porzioni|persone)/i);
      if (porzioniMatch) {
        document.getElementById('porzioniOriginali').value = porzioniMatch[2];
      }

      // Trova ingredienti
      const ingredienti = Array.from(html.querySelectorAll('li')).map(li => li.textContent).filter(t => /\d/.test(t));

      document.getElementById('ingredienti').innerHTML = '';
      ingredienti.forEach(text => {
        const regex = /([\d.,]+)\s*([a-zA-Z√Ä-√ø]+)?\s+(.+)/;
        const match = text.trim().match(regex);
        if (match) {
          const quantita = parseFloat(match[1].replace(',', '.')) || '';
          const unita = unitaMisura.includes(match[2]) ? match[2] : 'g';
          const nome = match[3];
          aggiungiIngrediente(nome, quantita, unita);
        } else {
          aggiungiIngrediente(text);
        }
      });
    })
    .catch(err => {
      alert("Errore durante il recupero della ricetta. Inserisci manualmente.");
    });
}
</script>
</body>
</html>
