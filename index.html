<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ricalcolatore Ricette</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #fff9f2;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    input, select, button {
      padding: 6px 10px;
      margin: 5px;
      font-size: 1rem;
    }
    .ingrediente-row {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 10px;
    }
    .ingrediente-row input, .ingrediente-row select {
      flex: 1;
      min-width: 100px;
    }
    .output {
      background-color: #f1f1f1;
      padding: 10px;
      margin-top: 20px;
    }
    .button-group {
      margin-top: 10px;
    }
    .ingredient-table {
      width: 100%;
      border-collapse: collapse;
    }
    .ingredient-table th, .ingredient-table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    .ingredient-table th {
      background-color: #f7e1c7;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ðŸ§® Ricalcolatore Ricette</h1>

  <h2>Parte 1: Inserisci URL di una ricetta</h2>
  <input type="text" id="urlInput" placeholder="Incolla qui l'URL della ricetta..." size="60">
  <input type="number" id="desiredPortionsURL" placeholder="Porzioni desiderate">
  <button onclick="caricaRicettaDaURL()">Carica e Ricalcola</button>

  <h2>Parte 2: Inserisci ricetta manualmente</h2>
  <input type="number" id="originalPortions" placeholder="Porzioni originali">
  <input type="number" id="desiredPortions" placeholder="Porzioni desiderate">
  <div id="ingredienti"></div>
  <div class="button-group">
    <button onclick="aggiungiIngrediente()">Aggiungi ingrediente</button>
    <button onclick="ricalcolaDosi()">Calcola</button>
    <button onclick="window.print()">Stampa</button>
  </div>

  <div class="output">
    <h2>Risultato</h2>
    <table class="ingredient-table" id="outputTable">
      <thead>
        <tr>
          <th>Ingrediente</th>
          <th>Dose Originale</th>
          <th>Dose Ricalcolata</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  const unitaMisura = [
    'g', 'kg', 'ml', 'l', 'pz', 'cucchiaino', 'cucchiaini', 'cucchiaio', 'cucchiai',
    'bicchiere', 'bicchieri', 'tazza', 'tazze', 'fetta', 'fette', 'spicchio', 'spicchi',
    'scatola', 'scatolette', 'bustina', 'bustine', 'confezione', 'confezioni', 'pizzico', 'pizzichi'
  ];

  function aggiungiIngrediente(nome = '', quantita = '', unita = '') {
    const div = document.createElement('div');
    div.className = 'ingrediente-row';
    div.innerHTML = `
      <input type="text" placeholder="Ingrediente" value="${nome}">
      <input type="number" placeholder="QuantitÃ " value="${quantita}">
      <select>
        ${unitaMisura.map(u => `<option value="${u}" ${u === unita ? 'selected' : ''}>${u}</option>`).join('')}
      </select>
    `;
    document.getElementById('ingredienti').appendChild(div);
  }

  function ricalcolaDosi() {
    const original = parseFloat(document.getElementById('originalPortions').value);
    const desired = parseFloat(document.getElementById('desiredPortions').value);
    const fattore = desired / original;
    const tbody = document.querySelector('#outputTable tbody');
    tbody.innerHTML = '';

    document.querySelectorAll('#ingredienti .ingrediente-row').forEach(row => {
      const nome = row.children[0].value;
      const quantita = parseFloat(row.children[1].value);
      const unita = row.children[2].value;
      const ricalcolata = unita.includes('pz') ? quantita * fattore : Math.round(quantita * fattore);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${nome}</td>
        <td>${quantita} ${unita}</td>
        <td>${ricalcolata} ${unita}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function parseIngredienteStringa(str) {
    const regex = /^(\d+[.,\/]?\d*|Â½|Â¼|Â¾)?\s*(\w+)?\s+(.*)$/;
    const match = str.match(regex);
    if (!match) return ['', '', str];
    let [_, quant, unit, name] = match;
    quant = quant?.replace(',', '.') === 'Â½' ? 0.5 : quant?.replace(',', '.') === 'Â¼' ? 0.25 : quant?.replace(',', '.') === 'Â¾' ? 0.75 : quant;
    return [name, parseFloat(quant), unit];
  }

  async function caricaRicettaDaURL() {
    const url = document.getElementById('urlInput').value;
    const desired = parseFloat(document.getElementById('desiredPortionsURL').value);

    try {
      const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
      const html = await response.text();

      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const scripts = doc.querySelectorAll('script[type="application/ld+json"]');

      let ricetta;
      for (let s of scripts) {
        const json = JSON.parse(s.textContent);
        if (json['@type'] === 'Recipe' || (Array.isArray(json['@type']) && json['@type'].includes('Recipe'))) {
          ricetta = json;
          break;
        }
      }

      if (!ricetta) return alert('Nessuna ricetta trovata.');

      const original = parseFloat(ricetta.recipeYield?.toString().match(/\d+/)?.[0] || 1);
      document.getElementById('originalPortions').value = original;
      document.getElementById('desiredPortions').value = desired;
      document.getElementById('ingredienti').innerHTML = '';

      ricetta.recipeIngredient.forEach(ing => {
        const [nome, quantita, unita] = parseIngredienteStringa(ing);
        aggiungiIngrediente(nome, quantita || '', unita || '');
      });
    } catch (e) {
      alert('Errore durante il caricamento della ricetta.');
    }
  }
</script>
</body>
</html>
